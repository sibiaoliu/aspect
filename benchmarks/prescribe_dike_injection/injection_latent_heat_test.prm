# This is a 2D test model of the dike injection functionality to determine
# that the latent heating term in the energy equation corresponding to 
# injection terms in the Stokes equations is working properly.

# Material is injected in the left half of the domain with a rate that
# corresponds to a velocity divergence of 1e-15 1/s and can flow
# out through the right boundary. This corresponds to a linear velocity 
# increase from 0 to 500 m * 1e-15 1/s = 5e-13 m/s in the right half
# of the domain.

# In the injection area, the rate of latent heat release upon crystallization
# (H_crys) and associated with the melt injection ((T_inj-T)*rho*Cp) is:
#
#   (H_crys + (T_inj - T) * rho * Cp) * injection_rate
#   = (1e11 + (2e5 - 0) * 1000 * 1000) J/m^3 * 1e-15 1/s 
#   =  3e-4 J/m^3/s
# 
# where T_inj is the temperature of the injected melt, T, rho, Cp are
# temperature, density and specific heat at the dike point, respectively.
#
# The latent heat release during crystallization:
# H_crys = injected_material_amount * latent heat * time step * injection_rate
#        = 1.0 * 1e11 J/m^3  * 1e10 s    * 1e-15 1/s      = 1e6 J/m^3
#
# This leads to a temperature change of 1 K (when divided by the density 
# and specific heat).

# Material is injected with an unrealistic temperature of 2e5 K, which
# in combination with the injection rate of 1e-15 1/s and the time step
# of 1e10 s leads to a temperature change of 2 K.
# This means the final temperature in the left half of the domain is 3 K. 

set Additional shared libraries            = ./libprescribed_dike_injection.debug.so
set Dimension                              = 2
set Adiabatic surface temperature          = 0
set Nonlinear solver scheme                = single Advection, iterated Stokes
set Output directory                       = output_injection_latent_heat_test
set End time                               = 2e10
set Maximum time step                      = 1e10
set Use years in output instead of seconds = false

##################### Prescribed dike injection ########################
# We need to enable the assembler that allows us to add terms
# to the Stokes equation. 
subsection Formulation
  set Enable prescribed dilation    = true
  set Enable dike injection         = true
end

# Here we use the Stokes discretization that is locally conservative for dike
# injection function, otherwise the solutions within the dike might be wrong.
subsection Discretization
  set Use locally conservative discretization      = true
  set Use discontinuous temperature discretization = true
  set Use discontinuous composition discretization = true
end

subsection Material model
  set Model name = prescribed dike injection
  subsection Prescribed dike injection
    set Base model = simple
    # Prescribe the amount of newly injected material
    set Dike material injection amout = 1.0
    subsection Dike injection function
      set Variable names       = x,y,t
      set Function expression  = if(x<=500, 1e-15, 0)
    end
  end
  subsection Simple model
    set Reference density             = 1000.
    set Reference specific heat       = 1000.
    set Thermal expansion coefficient = 0.
    set Thermal conductivity          = 0.
  end
end

subsection Heating model
  set List of model names = latent heat dike injection
  subsection Latent heat dike injection
    set Latent heat of crystallization = 1e11
    set Temperature of the injected material = 2e5
    set Dike material injection amount = 1.0
  end
end

##################### Model geometry ########################

subsection Geometry model
  set Model name = box
  subsection Box
    set X extent      = 1000
    set Y extent      = 1000
    set X repetitions = 10
    set Y repetitions = 10
  end
end

subsection Mesh refinement
  set Initial adaptive refinement              = 0
  set Initial global refinement                = 0
  set Time steps between mesh refinement       = 0
end

subsection Gravity model
  set Model name = vertical
  subsection Vertical
    set Magnitude = 10.0
  end
end

##################### Initial & Boundary Conditions ########################

subsection Boundary velocity model
  set Tangential velocity boundary indicators = top, bottom, left
end

# We prescribe the lithostatic pressure as a boundary traction on 
# the right side of the model, so that material can flow out according 
# to the inflow induced by the dike injection.
subsection Boundary traction model
  set Prescribed traction boundary indicators = right:initial lithostatic pressure
  subsection Initial lithostatic pressure
    set Representative point         = 1000, 1000
  end
end

subsection Initial temperature model
  set Model name = function
  subsection Function
    set Function expression       = 0
  end
end

subsection Compositional fields
  set Number of fields      = 1
  set Names of fields       = injection_phase
  set Types of fields       = chemical composition
end

subsection Initial composition model
  set Model name = function
  subsection Function
    set Variable names      =x,y
    set Function expression = 0
  end
end

subsection Postprocess
  set List of postprocessors = visualization, velocity statistics, temperature statistics
  subsection Visualization
    set List of output variables      = heating, named additional outputs,  strain rate tensor
    set Time between graphical output = 0
    set Interpolate output = false
  end
end