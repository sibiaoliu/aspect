##################### Global parameters #####################
#set Additional shared libraries            = ../../libprescribed_dike_injection.so
set Additional shared libraries = /scratch/usr/shkliusb/Aspect/src_dike_injection/libprescribed_dike_injection.so

set Dimension                              = 2
set Adiabatic surface temperature          = 293
set Pressure normalization                 = no
set Nonlinear solver scheme                = single Advection, iterated defect correction Stokes
set Output directory                       = output_M0.7_2col

set End time                               = 4e6 #3.156e13
set Use years in output instead of seconds = true
#set Maximum time step                      = 1e3 #3.156e10
set CFL number                             = 0.5

set Max nonlinear iterations               = 20
set Nonlinear solver tolerance             = 1.e-4
#set Max nonlinear iterations in pre-refinement       = 0

subsection Solver parameters
  subsection Stokes solver parameters
    set Number of cheap Stokes solver steps = 0
    set GMRES solver restart length = 100
  end
end

subsection Checkpointing
  set Steps between checkpoint             = 100
end
set Resume computation                     = auto

##################### Model geometry #########################

subsection Geometry model
  set Model name = box
  subsection Box
    set X extent      = 80e3
    set Y extent      = 40e3
    set X repetitions = 200
    set Y repetitions = 100 
  end
end

# The gravity is constant and points downward. 
subsection Gravity model
  set Model name = vertical
  subsection Vertical
    set Magnitude = 9.8
  end
end

##################### Mesh refinement #########################

subsection Mesh refinement
  set Initial adaptive refinement              = 0
  set Initial global refinement                = 1
  set Time steps between mesh refinement       = 0
  #set Strategy                                 = minimum refinement function
#  set Refinement fraction                      = 0.5
#  set Coarsening fraction                      = 0.5
#  subsection Minimum refinement function
#    set Coordinate system = cartesian
#    set Variable names = x,y
#    set Function constants = h=40e3, hd1=10e3, w1=1e3
#    set Function expression = if(y>=h-hd1, 2, 0)
#  end
end
                        
##################### Compositional Fields ############

subsection Compositional fields
  set Number of fields      = 3
  set Names of fields       = plastic_strain, oceanic_crust, mantle
end

subsection Initial composition model
  set Model name = function
  subsection Function
    set Variable names      =x,y
    set Function expression = 0; if(y>=34e3, 1, 0); if(y<34e3, 1, 0)
  end
end

subsection Boundary composition model
  set Fixed composition boundary indicators          = bottom
  set List of model names                            = initial composition
end

##################### Velocity ########################

subsection Boundary velocity model
  set Prescribed velocity boundary indicators = left x :function, \
                                                right x :function, \
                                                bottom y :function
  subsection Function 
    set Variable names      = x,y
    set Function constants  = cm=0.01, year=1
    set Function expression = if(x<40e3, -2*cm/year, 2*cm/year); 1.8*cm/year
  end    
end

# Advecting the free surface vertically rather than
# # in the surface normal direction can result in a
# # more stable mesh when the deformation is large
subsection Mesh deformation
  set Mesh deformation boundary indicators        = top: free surface, top: diffusion
  set Additional tangential mesh velocity boundary indicators = left,right
  subsection Free surface
    set Surface velocity projection = vertical
    set Free surface stabilization theta = 0.9
  end
  subsection Diffusion
    # Time_diff = CFL * dxyz_min^2 / kappa should be greater than numerical timestep
    set Hillslope transport coefficient = 0.25e-6
    set Time steps between diffusion    = 2
  end
end

# We prescribe the lithostatic pressure as a boundary traction on 
# the right side of the model, so that material can flow in and out 
# according to the flow induced by injection  
#subsection Boundary traction model
#  set Prescribed traction boundary indicators = bottom:initial lithostatic pressure
#  subsection Initial lithostatic pressure
    # We calculate the pressure profile at the right model boundary.
#    set Number of integration points = 2000 
#    set Representative point         = 80e3, 40e3
#  end
#end

##################### Temperature ########################

# a linear temperature distribution from the surface to the LAB (10 km)
# Tmoho = 600C, Tlab=1350C
# adiabatic mantle with the adiabat - C/km
subsection Initial temperature model
  set Model name = function
    subsection Function
      set Variable names = x,y
      set Function constants = h=40.e3,h1=6e3,h2=10e3,ts=273,tm=873, tl=1578, tb=1623
      set Function expression = if(y>=(h-h1), ts + (tm-ts)*(h-y)/h1, tm + (tb-tm)*(h-h1-y)/(h-h1))
    end
end
subsection Boundary temperature model
  set Fixed temperature boundary indicators = bottom, top
  set List of model names = box
  subsection Box
    set Top temperature = 273
    set Bottom temperature = 1623
  end
end

# We want to include latent heat of crystallization of the injected material 
# in the model.
# The latent heat source term = dilation_term * (Hf + (T_inject - T)*rho *Cp)
# TODO: ADD the compositional heating? 
subsection Heating model
  set List of model names = constant heating #, latent heat injection
  subsection Constant heating
    set Radiogenic heating rate = 1e-19
  end
#  subsection Latent heat injection
#    set Latent heat of crystallization = 1.1e9
#    set Temperature of injected melt = 1573
#  end
end

##################### Dilation  ########################

# We need to enable the assembler that allows us to add terms
# to the Stokes equation. 
subsection Formulation
  set Enable prescribed dilation = true
end

subsection Material model
  set Model name = prescribed dilation
  subsection Prescribed dilation
    set Base model = visco plastic
    subsection Injection function
      # The dike region is 400m * 6000m in the middle domain (2 columns),
      # The injection rate on one side is:
      # R_dike=2*M*u_half/w_dike= 2 * 0.5 * 20 mm/yr / 400 m  = 0.5e-4 1/yr
      set Function constants = M=0.7, u=0.02, w=400 
      set Function expression = if(x>=39.8e3 &x<=40.2e3 &y>=34e3, 2*M*u/w, 0)
    end
  end
 
  set Material averaging    = harmonic average
  subsection Visco Plastic
# Compositional fields : [background, total_strain, oc, olm, a]
    set Densities             = 3300, 3300, 3000, 3300
    set Minimum viscosity     = 1e19
    set Maximum viscosity     = 1e24
    set Reference strain rate = 1e-15
    set Minimum strain rate   = 1e-19
    set Reference temperature = 293
    set Reference viscosity   = 1e21
    set Heat capacities       = 1000
    set Thermal expansivities = 3.e-5 #3.e-5, 3.e-5, 2.7e-5, 3.e-5, 3.e-5
    set Define thermal conductivities = true
    set Thermal conductivities = 2.25
    #set Thermal diffusivities = 8.333333e-7, 8.333333e-7, 7.142857e-7, \
                               # 7.142857e-7, 8.333333e-7, 8.333333e-7

    # Choose to have the viscosity (pre-yield) follow a dislocation flow law.
    # O.C.: Maryland Diabase (Mackwell et al. 1998)
    # O.L.M.: Wet Olivine (Hirth and Kohlstedt 2003)
    # TODO: Use Dry Olivine for the mantle; e.g., Gerya 2013?
    set Viscosity averaging scheme = harmonic
    set Viscous flow law = dislocation
    set Prefactors for dislocation creep = 3.77e-14, 3.77e-14, 5.78e-27, 3.77e-14
    set Stress exponents for dislocation creep = 3.5, 3.5, 4.7, 3.5
    set Activation energies for dislocation creep = 520.e3, 520.e3, 485.e3, 520.e3
    set Activation volumes for dislocation creep  = 22.e-6, 22.e-6, 0, 22.e-6

    # Plasticity parameters
    set Angles of internal friction = 30
    set Cohesions                   = 30.e6
    set Strain weakening mechanism  = plastic weakening with plastic strain only
    set Start plasticity strain weakening intervals = 0
    set End plasticity strain weakening intervals   = 0.3
    set Cohesion strain weakening factors           = 1, 1, 0.1, 1
    end

    # TODO: strain healing? 1e12 s
end

##################### Postprocessing ########################

subsection Postprocess
  set List of postprocessors = velocity statistics,temperature statistics,visualization, topography
  subsection Visualization
    set List of output variables = density, viscosity, strain rate, stress, named additional outputs
                                  # maximum horizontal compressive stress, heating, vertical heat flux

    set Output format = vtu
    set Time between graphical output = 5e4
    set Interpolate output = true
    set Write higher order output = true  
    set Number of grouped files             = 1
  end
#  subsection Topography
#    set Output to file                              = true
#    set Time between text output                    = 5e5
#  end
end
